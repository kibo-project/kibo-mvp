CREATE TABLE public.users (
  country text,
  wallet text NOT NULL UNIQUE,
  privy_id text NOT NULL UNIQUE,
  email text,
  bank_name text,
  account_number text,
  account_holder text,
  phone text,
  last_login_at timestamp without time zone,
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  available_balance numeric DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  name text,
  CONSTRAINT users_pkey PRIMARY KEY (id)
);

CREATE TABLE public.roles (
  created_at date,
  name text NOT NULL UNIQUE CHECK (name = ANY (ARRAY['user'::text, 'ally'::text, 'admin'::text])),
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  CONSTRAINT roles_pkey PRIMARY KEY (id)
);

CREATE TABLE public.users_roles (
  user_id uuid NOT NULL,
  role_id uuid NOT NULL,
  CONSTRAINT users_roles_pkey PRIMARY KEY (user_id, role_id),
  CONSTRAINT user_roles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_roles_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.roles(id)
);

CREATE TABLE public.users_sessions (
  jwt_token text NOT NULL,
  refresh_token text,
  user_id uuid NOT NULL,
  last_login_at timestamp without time zone DEFAULT now(),
  expires_at timestamp without time zone NOT NULL,
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT users_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT user_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);

CREATE TABLE public.images (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp without time zone DEFAULT now(),
  name text,
  extension text,
  CONSTRAINT images_pkey PRIMARY KEY (id)
);

CREATE TABLE public.orders (
  expires_at timestamp without time zone,
  description text,
  recipient text,
  taken_at timestamp without time zone,
  ally_id uuid,
  qr_image uuid,
  completed_at timestamp with time zone,
  user_id uuid NOT NULL,
  fiat_amount numeric NOT NULL,
  crypto_amount numeric NOT NULL,
  tx_hash text,
  confirmation_proof text,
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  fiat_currency text NOT NULL DEFAULT 'USD'::text,
  crypto_currency text NOT NULL DEFAULT 'USDT'::text,
  status text NOT NULL DEFAULT 'PENDING_PAYMENT'::text CHECK (status = ANY (ARRAY['PENDING_PAYMENT'::text, 'AVAILABLE'::text, 'TAKEN'::text, 'COMPLETED'::text, 'CANCELLED'::text, 'REFUNDED'::text])),
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  escrow_address text,
  qr_image_url text,
  confirmation_proof_url text,
  CONSTRAINT orders_pkey PRIMARY KEY (id),
  CONSTRAINT orders_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);

CREATE TABLE public.escrow_logs (
  order_id uuid NOT NULL,
  action text NOT NULL,
  tx_hash text,
  message text,
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT escrow_logs_pkey PRIMARY KEY (id),
  CONSTRAINT escrow_logs_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
